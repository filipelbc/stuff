#!/bin/bash

# This script will check and list warning on your .org file
# The script was based on the code discussed in the link below:
# Reference: https://emacs.stackexchange.com/questions/42196/how-to-call-org-lint-against-org-mode-file-from-command-line

: ${ORG_EMACS_EL:='~/.emacs'}

die() {
    >&2 echo "$@"
    exit 1
}

lint() {
    echo "File: $1"

    emacs --batch -f package-initialize --eval "(add-hook 'org-mode-hook
      (lambda ()
          (let* (
            (Col1 'Line)
            (Col3 'Issue)
            (lint-report (org-lint))
            )
          (if (car lint-report)
            (progn
              (princ (format \"%6s  %s\n\" Col1 Col3))
              (dolist (element lint-report)
                (setq report (car (cdr element)))
                (princ (format \"%6s  %s\n\" (elt report 0) (elt report 2))))
              (error (kill-emacs 1))
            )
          )
      )))" "$1"
}

r=0

for i in "$@"
do
    if [ -f "$i" ]
    then
        if ! lint "$i"
        then
            r=1
        fi
    else
        die "File not found: $i"
    fi
done

exit $r
